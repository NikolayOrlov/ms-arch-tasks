apiVersion: apps/v1
kind: Deployment
metadata:
  name: authservice
  labels:
    app: authservice
spec:
  replicas: 2
  selector:
    matchLabels:
      app: authservice
  template:
    metadata:
      labels:
        app: authservice
    spec:
      volumes:
        - name: logs
          emptyDir: {}
        - name: promtail-config
          configMap:
            name: promtail-configmap
      containers:
        - image: grafana/promtail:3.2.0
          name: promtail
          env:
            - name: SERVICE_NAME
              value: authservice
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          imagePullPolicy: IfNotPresent
          args:
            - -config.file=/etc/promtail/promtail-config.yaml
            - -config.expand-env=true
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
            - name: promtail-config
              mountPath: /etc/promtail
        - image: gmnvnorlov/ms-arch-tasks-authservice:3.1.3
          name: authservice-container
          env:
            - name: postgres_url
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_url
            - name: postgres_database
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_database
            - name: postgres_username
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_username
            - name: postgres_password
              valueFrom:
                secretKeyRef:
                  name: common-secrets
                  key: postgres_password
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8080
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: profileservice
  labels:
    app: profileservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: profileservice
  template:
    metadata:
      labels:
        app: profileservice
    spec:
      volumes:
        - name: logs
          emptyDir: {}
        - name: promtail-config
          configMap:
            name: promtail-configmap
      containers:
        - image: grafana/promtail:3.2.0
          name: promtail
          env:
            - name: SERVICE_NAME
              value: profileservice
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          imagePullPolicy: IfNotPresent
          args:
            - -config.file=/etc/promtail/promtail-config.yaml
            - -config.expand-env=true
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
            - name: promtail-config
              mountPath: /etc/promtail
        - image: gmnvnorlov/ms-arch-tasks-profileservice:3.1.1
          name: profileservice-container
          env:
            - name: postgres_url
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_url
            - name: postgres_database
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_database
            - name: postgres_username
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_username
            - name: postgres_password
              valueFrom:
                secretKeyRef:
                  name: common-secrets
                  key: postgres_password
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /api/profileservice/actuator/health
              port: 8080
          readinessProbe:
            httpGet:
              path: /api/profileservice/actuator/health
              port: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: checkoutservice
  labels:
    app: checkoutservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: checkoutservice
  template:
    metadata:
      labels:
        app: checkoutservice
    spec:
      volumes:
        - name: logs
          emptyDir: {}
        - name: promtail-config
          configMap:
            name: promtail-configmap
      containers:
        - image: grafana/promtail:3.2.0
          name: promtail
          env:
            - name: SERVICE_NAME
              value: checkoutservice
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          imagePullPolicy: IfNotPresent
          args:
            - -config.file=/etc/promtail/promtail-config.yaml
            - -config.expand-env=true
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
            - name: promtail-config
              mountPath: /etc/promtail
        - image: gmnvnorlov/ms-arch-tasks-checkoutservice:3.2.2
          name: checkoutservice-container
          env:
            - name: postgres_url
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_url
            - name: postgres_database
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_database
            - name: postgres_username
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_username
            - name: postgres_password
              valueFrom:
                secretKeyRef:
                  name: common-secrets
                  key: postgres_password
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /api/checkoutservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/checkoutservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: orderservice
  labels:
    app: orderservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: orderservice
  template:
    metadata:
      labels:
        app: orderservice
    spec:
      volumes:
        - name: logs
          emptyDir: {}
        - name: promtail-config
          configMap:
            name: promtail-configmap
      containers:
        - image: grafana/promtail:3.2.0
          name: promtail
          env:
            - name: SERVICE_NAME
              value: orderservice
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          imagePullPolicy: IfNotPresent
          args:
            - -config.file=/etc/promtail/promtail-config.yaml
            - -config.expand-env=true
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
            - name: promtail-config
              mountPath: /etc/promtail
        - image: gmnvnorlov/ms-arch-tasks-orderservice:3.5.2
          name: orderservice-container
          env:
            - name: postgres_url
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_url
            - name: postgres_database
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_database
            - name: postgres_username
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_username
            - name: postgres_password
              valueFrom:
                secretKeyRef:
                  name: common-secrets
                  key: postgres_password
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /api/orderservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/orderservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cartservice
  labels:
    app: cartservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cartservice
  template:
    metadata:
      labels:
        app: cartservice
    spec:
      volumes:
        - name: logs
          emptyDir: {}
        - name: promtail-config
          configMap:
            name: promtail-configmap
      containers:
        - image: grafana/promtail:3.2.0
          name: promtail
          env:
            - name: SERVICE_NAME
              value: cartservice
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          imagePullPolicy: IfNotPresent
          args:
            - -config.file=/etc/promtail/promtail-config.yaml
            - -config.expand-env=true
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
            - name: promtail-config
              mountPath: /etc/promtail
        - image: gmnvnorlov/ms-arch-tasks-cartservice:3.1.2
          name: cartservice-container
          env:
            - name: postgres_url
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_url
            - name: postgres_database
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_database
            - name: postgres_username
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_username
            - name: postgres_password
              valueFrom:
                secretKeyRef:
                  name: common-secrets
                  key: postgres_password
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /api/cartservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/cartservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: stockservice
  labels:
    app: stockservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: stockservice
  template:
    metadata:
      labels:
        app: stockservice
    spec:
      volumes:
        - name: logs
          emptyDir: {}
        - name: promtail-config
          configMap:
            name: promtail-configmap
      containers:
        - image: grafana/promtail:3.2.0
          name: promtail
          env:
            - name: SERVICE_NAME
              value: stockservice
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          imagePullPolicy: IfNotPresent
          args:
            - -config.file=/etc/promtail/promtail-config.yaml
            - -config.expand-env=true
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
            - name: promtail-config
              mountPath: /etc/promtail
        - image: gmnvnorlov/ms-arch-tasks-stockservice:3.3.1
          name: stockservice-container
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
          env:
            - name: postgres_url
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_url
            - name: postgres_database
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_database
            - name: postgres_username
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_username
            - name: postgres_password
              valueFrom:
                secretKeyRef:
                  name: common-secrets
                  key: postgres_password
            - name: kafka_servers
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: kafka_servers
            - name: products_topic
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: products_topic
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /api/stockservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/stockservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notificationservice
  labels:
    app: notificationservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: notificationservice
  template:
    metadata:
      labels:
        app: notificationservice
    spec:
      volumes:
        - name: logs
          emptyDir: {}
        - name: promtail-config
          configMap:
            name: promtail-configmap
      containers:
        - image: grafana/promtail:3.2.0
          name: promtail
          env:
            - name: SERVICE_NAME
              value: notificationservice
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          imagePullPolicy: IfNotPresent
          args:
            - -config.file=/etc/promtail/promtail-config.yaml
            - -config.expand-env=true
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
            - name: promtail-config
              mountPath: /etc/promtail
        - image: gmnvnorlov/ms-arch-tasks-notificationservice:2.1.2
          name: notificationservice-container
          env:
            - name: postgres_url
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_url
            - name: postgres_database
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_database
            - name: postgres_username
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_username
            - name: postgres_password
              valueFrom:
                secretKeyRef:
                  name: common-secrets
                  key: postgres_password
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /api/notificationservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/notificationservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: productservice
  labels:
    app: productservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: productservice
  template:
    metadata:
      labels:
        app: productservice
    spec:
      volumes:
        - name: logs
          emptyDir: {}
        - name: promtail-config
          configMap:
            name: promtail-configmap
      containers:
        - image: grafana/promtail:3.2.0
          name: promtail
          env:
            - name: SERVICE_NAME
              value: productservice
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          imagePullPolicy: IfNotPresent
          args:
            - -config.file=/etc/promtail/promtail-config.yaml
            - -config.expand-env=true
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
            - name: promtail-config
              mountPath: /etc/promtail
        - image: gmnvnorlov/ms-arch-tasks-productservice:2.2.1
          name: productservice-container
          env:
            - name: postgres_url
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_url
            - name: postgres_database
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_database
            - name: postgres_username
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_username
            - name: postgres_password
              valueFrom:
                secretKeyRef:
                  name: common-secrets
                  key: postgres_password
            - name: kafka_servers
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: kafka_servers
            - name: products_topic
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: products_topic
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /api/productservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/productservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deliveryservice
  labels:
    app: deliveryservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: deliveryservice
  template:
    metadata:
      labels:
        app: deliveryservice
    spec:
      volumes:
        - name: logs
          emptyDir: {}
        - name: promtail-config
          configMap:
            name: promtail-configmap
      containers:
        - image: grafana/promtail:3.2.0
          name: promtail
          env:
            - name: SERVICE_NAME
              value: deliveryservice
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          imagePullPolicy: IfNotPresent
          args:
            - -config.file=/etc/promtail/promtail-config.yaml
            - -config.expand-env=true
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
            - name: promtail-config
              mountPath: /etc/promtail
        - image: gmnvnorlov/ms-arch-tasks-deliveryservice:2.1.2
          name: deliveryservice-container
          env:
            - name: postgres_url
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_url
            - name: postgres_database
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_database
            - name: postgres_username
              valueFrom:
                configMapKeyRef:
                  name: common-configs
                  key: postgres_username
            - name: postgres_password
              valueFrom:
                secretKeyRef:
                  name: common-secrets
                  key: postgres_password
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          volumeMounts:
            - name: logs
              mountPath: /var/log/application
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /api/deliveryservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/deliveryservice/actuator/health
              port: 8080
            timeoutSeconds: 5
            initialDelaySeconds: 120
            periodSeconds: 10